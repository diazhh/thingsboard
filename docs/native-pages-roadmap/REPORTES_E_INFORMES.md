# Sistema de Reportes e Informes - GDT Tank Gauging

**Fecha:** 1 de diciembre de 2025
**Versión:** 1.0

---

## Índice

1. [Introducción](#introducción)
2. [Tipos de Reportes](#tipos-de-reportes)
3. [Reportes de Inventario](#reportes-de-inventario)
4. [Reportes de Custody Transfer](#reportes-de-custody-transfer)
5. [Reportes de Análisis](#reportes-de-análisis)
6. [Reportes Históricos](#reportes-históricos)
7. [Sistema de Exportaciones](#sistema-de-exportaciones)
8. [Configurador de Reportes Automáticos](#configurador-de-reportes-automáticos)
9. [Especificaciones Técnicas](#especificaciones-técnicas)

---

## Introducción

El sistema de reportes e informes es fundamental para la operación diaria, análisis de datos, cumplimiento regulatorio y toma de decisiones. Este documento especifica todos los tipos de reportes que debe generar el sistema GDT.

### Requisitos Generales

- **Formatos de Salida:** PDF, CSV, Excel (.xlsx)
- **Internacionalización:** Soporte de múltiples idiomas (ES, EN)
- **Branding:** Logo y datos de la empresa configurables
- **Firmas:** Campos de firma para reportes oficiales
- **Timestamps:** Fecha/hora de generación con zona horaria
- **Trazabilidad:** Referencia a versión de software y configuración usada

---

## Tipos de Reportes

### Clasificación por Categoría

1. **Reportes de Inventario (7 tipos)**
   - Daily Inventory Report
   - Tank Inventory Summary
   - Product Inventory by Group
   - Tank Status Report
   - Capacity Utilization Report
   - Low Stock Alert Report
   - Overfill Risk Report

2. **Reportes de Custody Transfer (4 tipos)**
   - Batch Transfer Report
   - Batch History Report
   - Mass Balance Report
   - Transfer Reconciliation Report

3. **Reportes de Análisis (5 tipos)**
   - Laboratory Analysis Report
   - Manual Gauging Report
   - Deviation Analysis Report
   - Temperature Profile Report
   - Density Variation Report

4. **Reportes Históricos (6 tipos)**
   - Historical Level Trends
   - Historical Volume Trends
   - Alarm History Report
   - Event Log Report (OIML R85)
   - Configuration Change History
   - Performance Metrics Report

5. **Reportes de Cumplimiento (3 tipos)**
   - OIML R85 Compliance Report
   - Audit Trail Summary
   - Calibration Status Report

**Total: 25 tipos de reportes**

---

## Reportes de Inventario

### 1. Daily Inventory Report

**Descripción:** Reporte diario del inventario de todos los tanques al finalizar el día.

**Frecuencia:** Diario (generado automáticamente a las 23:59)

**Datos Incluidos:**
- Fecha del reporte
- Lista de todos los tanques
- Por cada tanque:
  - Tank Tag
  - Product
  - Level (ft/in o mm)
  - Temperature (°F o °C)
  - TOV, GOV, GSV, NSV
  - Masa (kg o lb)
  - WIA (Weight In Air)
  - % Capacity
  - Status (idle, receiving, dispensing)
  - Alarmas activas

**Formato de Salida:** PDF, Excel

**Template PDF:**
```
┌─────────────────────────────────────────────────┐
│  [Logo]        DAILY INVENTORY REPORT           │
│                                                  │
│  Date: December 1, 2025  Time: 23:59:00 UTC     │
│  Report ID: DIR-20251201-001                    │
└─────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ Tank   │ Product  │ Level  │ Temp │ NSV   │ %Cap │ Status   │
├──────────────────────────────────────────────────────────────┤
│ TK-101 │ Crude Oil│ 25.5ft │ 72°F │12,450 │ 82%  │ Idle     │
│ TK-102 │ Diesel   │ 18.2ft │ 68°F │ 8,320 │ 65%  │ Receiving│
│ ...                                                          │
└──────────────────────────────────────────────────────────────┘

TOTAL INVENTORY BY PRODUCT:
- Crude Oil:    125,340 bbl
- Diesel:        85,200 bbl
- Gasoline:      42,100 bbl

Generated by GDT Tank Gauging System v1.0
Timestamp: 2025-12-01 23:59:00 UTC
```

**Implementación:**
- Service: `ReportService.generateDailyInventoryReport(date)`
- Scheduler: Cron job diario a las 23:59
- Storage: PDF guardado en S3 o local storage
- Notificación: Email a lista de distribución

---

### 2. Tank Inventory Summary

**Descripción:** Resumen consolidado del inventario actual de todos los tanques.

**Frecuencia:** On-demand (generado por usuario)

**Datos Incluidos:**
- Snapshot en tiempo real
- Totales por producto
- Totales por grupo de tanques
- Gráficos:
  - Pie chart de distribución por producto
  - Bar chart de capacidad utilizada por tanque

**Formato de Salida:** PDF, Excel

---

### 3. Product Inventory by Group

**Descripción:** Inventario agrupado por tipo de producto.

**Frecuencia:** On-demand o programado (semanal, mensual)

**Datos Incluidos:**
- Total volume por producto
- Total mass por producto
- Número de tanques por producto
- Average capacity utilization
- Trends (comparación con periodo anterior)

**Formato de Salida:** PDF, Excel

---

### 4. Tank Status Report

**Descripción:** Reporte del estado operacional de cada tanque.

**Frecuencia:** On-demand

**Datos Incluidos:**
- Tank Tag
- Current status (idle, receiving, dispensing)
- Last movement (tipo y timestamp)
- Communication status con radar
- Alarmas activas
- Last calibration date
- Next calibration due

**Formato de Salida:** PDF, Excel

---

### 5. Capacity Utilization Report

**Descripción:** Análisis de utilización de capacidad de tanques.

**Frecuencia:** Semanal, mensual

**Datos Incluidos:**
- % Utilization por tanque
- Available capacity
- Trends de utilización (últimos 30 días)
- Tanques subutilizados (<30%)
- Tanques sobrecargados (>90%)
- Recomendaciones de optimización

**Formato de Salida:** PDF con gráficos

---

### 6. Low Stock Alert Report

**Descripción:** Alerta de tanques con stock bajo.

**Frecuencia:** Diario o on-demand

**Datos Incluidos:**
- Tanques con nivel < threshold configurado
- Current level y NSV
- Estimated time to empty (basado en tasa de consumo)
- Recommended reorder point

**Formato de Salida:** PDF, Email alert

---

### 7. Overfill Risk Report

**Descripción:** Reporte de tanques en riesgo de sobrellenado.

**Frecuencia:** On-demand o al detectar riesgo

**Datos Incluidos:**
- Tanques con nivel > 85% capacity
- Tanques en estado "receiving" cerca de HH
- Rate of fill (mm/hour)
- Estimated time to HH alarm
- Acciones recomendadas

**Formato de Salida:** PDF, Email alert urgente

---

## Reportes de Custody Transfer

### 8. Batch Transfer Report

**Descripción:** Reporte oficial de transferencia de custody (YA ESPECIFICADO EN FASE 2)

**Frecuencia:** Generado automáticamente al cerrar batch

**Datos Incluidos:**
- Batch Number
- Tank information
- Product
- Opening Gauge (nivel, temp, API gravity, TOV, GOV, GSV, NSV, Masa, WIA)
- Closing Gauge (igual que opening)
- Transferred Quantities (NSV, Masa, WIA)
- API MPMS Calculations Breakdown:
  - CTL (Coefficient of Thermal expansion for Liquid)
  - CTSh (Shell correction)
  - CPL (Pressure correction)
  - VCF (Volume Correction Factor) usado
  - API Table type (6A/6B/6C/6D)
- Metadata:
  - Destination
  - Transport vehicle
  - Seal numbers
  - Operators (opening, closing)
  - Timestamps
- Signatures:
  - Opening operator
  - Closing operator
  - Supervisor
- QR Code: Link a verificación digital
- Watermark: "RECALCULATED" si aplica

**Formato de Salida:** PDF firmado digitalmente

**Requisitos OIML R85:**
- ✅ Timestamp preciso (NTP)
- ✅ Firma digital SHA-256
- ✅ Immutable (no editable)
- ✅ Retención 2+ años

**Template PDF:**
```
┌─────────────────────────────────────────────────┐
│  [Logo]      BATCH TRANSFER REPORT              │
│                                                  │
│  Batch Number: BT-20251201-001                  │
│  Date: December 1, 2025                         │
└─────────────────────────────────────────────────┘

TANK INFORMATION:
Tank: TK-101 (Crude Oil Storage)
Product: Crude Oil
API Gravity: 35.5°API

OPENING GAUGE:
Date/Time: 2025-12-01 08:00:00 UTC
Operator: John Doe
Level: 25.5 ft  Temperature: 72°F
TOV: 12,450 bbl  GOV: 12,380 bbl
GSV: 12,320 bbl  NSV: 12,280 bbl
Mass: 1,542,000 kg  WIA: 1,540,800 kg

CLOSING GAUGE:
Date/Time: 2025-12-01 16:30:00 UTC
Operator: Jane Smith
Level: 18.2 ft  Temperature: 73°F
TOV: 8,920 bbl   GOV: 8,870 bbl
GSV: 8,830 bbl   NSV: 8,800 bbl
Mass: 1,105,000 kg  WIA: 1,104,200 kg

TRANSFERRED QUANTITIES:
NSV Transferred: 3,480 bbl
Mass Transferred: 437,000 kg
WIA Transferred: 436,600 kg

API MPMS CALCULATIONS:
API Table Used: 6A (Crude Oils)
CTL: 0.99125
VCF: 0.99056
CTSh: 1.00023
CPL: 1.00000 (atmospheric tank)

DESTINATION:
Destination: Refinery A
Vehicle: Truck TR-456
Seal Numbers: S-12345, S-12346

SIGNATURES:
Opening Operator: _________________ Date: _______
Closing Operator: _________________ Date: _______
Supervisor: _______________________ Date: _______

[QR CODE]

Report ID: BTR-20251201-001-TK101
Generated: 2025-12-01 16:35:00 UTC
GDT Tank Gauging System v1.0 | Certified OIML R85
```

---

### 9. Batch History Report

**Descripción:** Historial de batches para un tanque o periodo.

**Frecuencia:** On-demand

**Parámetros:**
- Tank ID (opcional, all si no especificado)
- Date range
- Batch type (receiving, dispensing, all)
- Status (open, closed, recalculated, voided)

**Datos Incluidos:**
- Lista de batches con:
  - Batch Number
  - Tank
  - Type
  - Opening/Closing timestamps
  - Transferred NSV
  - Status
- Totales:
  - Total received NSV
  - Total dispensed NSV
  - Net change

**Formato de Salida:** Excel, PDF

---

### 10. Mass Balance Report

**Descripción:** Balance de masa para detectar discrepancias.

**Frecuencia:** Diario, semanal, mensual, on-demand

**Parámetros:**
- Tank ID o grupo de tanques
- Start date, End date

**Cálculo:**
```
Opening Inventory + Receipts - Deliveries = Expected Closing
Actual Closing - Expected Closing = Discrepancy
Discrepancy % = (Discrepancy / Expected Closing) * 100
```

**Datos Incluidos:**
Por cada tanque:
- Opening Inventory (NSV at start date)
- Receipts (suma de batches receiving)
- Deliveries (suma de batches dispensing)
- Expected Closing
- Actual Closing (NSV at end date)
- Discrepancy (valor absoluto)
- Discrepancy %
- Assessment:
  - ✅ Aceptable (< 0.5%)
  - ⚠️ Revisar (0.5-1%)
  - ❌ Crítico (> 1%)

**Formato de Salida:** PDF con gráficos, Excel

**Template PDF:**
```
┌─────────────────────────────────────────────────┐
│  [Logo]      MASS BALANCE REPORT                │
│                                                  │
│  Period: Dec 1-7, 2025                          │
│  Report ID: MBR-20251207-001                    │
└─────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│ Tank   │Opening│Receipts│Deliveries│Expected│ Actual │Discrepancy│    %    │Status│
│        │  NSV  │  NSV   │   NSV    │Closing │Closing │    NSV    │         │      │
├────────────────────────────────────────────────────────────────────────────────┤
│TK-101  │12,280 │ 8,500  │  15,200  │ 5,580  │ 5,550  │   -30     │ -0.54%  │  ⚠️  │
│TK-102  │ 8,800 │ 5,200  │   2,100  │11,900  │11,920  │   +20     │ +0.17%  │  ✅  │
│TK-103  │ 6,450 │ 3,100  │   4,200  │ 5,350  │ 5,280  │   -70     │ -1.31%  │  ❌  │
└────────────────────────────────────────────────────────────────────────────────┘

SUMMARY:
Total Discrepancy: -80 bbl (-0.56%)

TANKS REQUIRING ATTENTION:
❌ TK-103: -1.31% discrepancy (exceeds 1% threshold)
   → Recommended Action: Inspect for leaks, verify calibration

⚠️ TK-101: -0.54% discrepancy (review recommended)
   → Recommended Action: Verify batch records

[Bar Chart of Discrepancies]

Generated: 2025-12-07 23:59:00 UTC
```

---

### 11. Transfer Reconciliation Report

**Descripción:** Reconciliación de transferencias entre tanques.

**Frecuencia:** On-demand

**Uso:** Verificar transferencias internas (TK-A → TK-B)

**Datos Incluidos:**
- Source tank batch (dispensing)
- Destination tank batch (receiving)
- Quantities comparison
- Loss/gain calculation
- Acceptable loss range (configurable)

---

## Reportes de Análisis

### 12. Laboratory Analysis Report

**Descripción:** Reporte consolidado de análisis de laboratorio.

**Frecuencia:** On-demand, semanal

**Parámetros:**
- Tank ID
- Date range
- Analysis type (API Gravity, BS&W, Density)

**Datos Incluidos:**
- Lista de análisis con:
  - Date/Time
  - Tank
  - API Gravity
  - BS&W %
  - Density
  - Temperature
  - Analyst ID
  - Notes
- Gráficos:
  - Trend de API Gravity
  - Trend de BS&W
  - Comparación entre tanques

**Formato de Salida:** PDF con gráficos, Excel

---

### 13. Manual Gauging Report

**Descripción:** Reporte de mediciones manuales de aforo.

**Frecuencia:** On-demand

**Datos Incluidos:**
- Lista de mediciones manuales
- Comparación automático vs manual
- Cálculo de desviación
- Gráficos de desviación en el tiempo

**Formato de Salida:** PDF, Excel

---

### 14. Deviation Analysis Report

**Descripción:** Análisis de desviaciones entre mediciones automáticas y manuales.

**Frecuencia:** Semanal, mensual

**Datos Incluidos:**
- Desviación promedio por tanque
- Desviación máxima registrada
- Tanques con desviación consistente > threshold
- Recomendaciones de calibración

**Formato de Salida:** PDF con gráficos

---

### 15. Temperature Profile Report

**Descripción:** Reporte de perfiles de temperatura de tanques.

**Frecuencia:** On-demand

**Datos Incluidos:**
- Temperature average
- Temperature gradient (si múltiples sensores)
- Variación térmica en el tiempo
- Impacto en cálculos de volumen

**Formato de Salida:** PDF con gráficos

---

### 16. Density Variation Report

**Descripción:** Análisis de variación de densidad de productos.

**Frecuencia:** Mensual, on-demand

**Datos Incluidos:**
- Density trends
- Variación de API Gravity
- Impacto en cálculos de masa

**Formato de Salida:** PDF

---

## Reportes Históricos

### 17. Historical Level Trends

**Descripción:** Tendencias históricas de nivel de tanques.

**Frecuencia:** On-demand

**Parámetros:**
- Tank ID(s)
- Date range
- Aggregation (hourly, daily, weekly)

**Datos Incluidos:**
- Gráfico de líneas de nivel en el tiempo
- Min/Max/Average level
- Detección de anomalías
- Rate of change analysis

**Formato de Salida:** PDF con gráficos interactivos, Excel

---

### 18. Historical Volume Trends

**Descripción:** Tendencias históricas de volúmenes (TOV, GOV, GSV, NSV).

**Frecuencia:** On-demand

**Datos Incluidos:**
- Múltiples series en gráfico (TOV, GOV, GSV, NSV)
- Comparación entre tanques
- Estadísticas (promedio, desviación estándar)

**Formato de Salida:** PDF, Excel

---

### 19. Alarm History Report

**Descripción:** Historial de alarmas del sistema.

**Frecuencia:** On-demand, mensual

**Parámetros:**
- Date range
- Tank ID (opcional)
- Alarm type (Level HH, H, L, LL, Rate, Deviation, Device)
- Severity (Critical, Major, Minor)

**Datos Incluidos:**
- Lista de alarmas:
  - Timestamp
  - Tank
  - Alarm Type
  - Severity
  - Value that triggered alarm
  - Acknowledged by (user)
  - Cleared timestamp
  - Duration
- Estadísticas:
  - Total alarms
  - Alarms by type (pie chart)
  - Alarms by tank (bar chart)
  - Average duration
  - Top 5 tanques con más alarmas

**Formato de Salida:** PDF con gráficos, Excel

---

### 20. Event Log Report (OIML R85)

**Descripción:** Reporte de audit trail para cumplimiento OIML R85.

**Frecuencia:** On-demand, mensual

**Datos Incluidos:**
- Lista de eventos metrológicos:
  - Timestamp (NTP-synced)
  - Event Type
  - User
  - Device/Tank affected
  - Parameter changed
  - Old value → New value
  - Digital signature (SHA-256)
- Verificación de integridad:
  - ✅ All signatures valid
  - ❌ Corrupted events (si los hay)

**Formato de Salida:** PDF firmado digitalmente, CSV

**Requisitos:**
- Immutable log
- 2+ años de retención
- Firmas verificables

---

### 21. Configuration Change History

**Descripción:** Historial de cambios de configuración.

**Frecuencia:** On-demand

**Datos Incluidos:**
- Changes a:
  - Tank parameters
  - Strapping tables
  - Alarm thresholds
  - Radar configuration
  - User permissions

**Formato de Salida:** PDF, Excel

---

### 22. Performance Metrics Report

**Descripción:** Métricas de rendimiento del sistema.

**Frecuencia:** Mensual

**Datos Incluidos:**
- Communication uptime con radares
- Average latency telemetría
- Failed RPC commands
- System availability %
- Alarm response time

**Formato de Salida:** PDF con gráficos

---

## Reportes de Cumplimiento

### 23. OIML R85 Compliance Report

**Descripción:** Reporte de cumplimiento con estándar OIML R85.

**Frecuencia:** Anual, on-demand para auditoría

**Datos Incluidos:**
- Checklist de requisitos OIML R85:
  - ✅ Event logger funcional
  - ✅ Retención 2+ años
  - ✅ Sellado electrónico implementado
  - ✅ NTP sync activo
  - ✅ Firmas digitales verificadas
  - ✅ MPE (Maximum Permissible Errors) cumplidos
- Test results:
  - Accuracy tests
  - Repeatability tests
  - Hysteresis tests
- Calibration records
- Certification status

**Formato de Salida:** PDF oficial

---

### 24. Audit Trail Summary

**Descripción:** Resumen ejecutivo de audit trail.

**Frecuencia:** Mensual, trimestral

**Datos Incluidos:**
- Total events logged
- Events by type
- Users más activos
- Suspicious activity (si detectada)
- Compliance status

**Formato de Salida:** PDF

---

### 25. Calibration Status Report

**Descripción:** Estado de calibración de radares y tanques.

**Frecuencia:** Mensual

**Datos Incluidos:**
- Devices/tanks requiring calibration
- Last calibration date
- Next calibration due
- Overdue calibrations (alertas)
- Calibration history

**Formato de Salida:** PDF, Excel

---

## Sistema de Exportaciones

### Formatos Soportados

#### 1. PDF
- **Librería:** jsPDF (frontend) o reportlab (backend Python)
- **Características:**
  - Header con logo
  - Footer con página/total
  - Tablas formateadas
  - Gráficos embebidos (ECharts → image)
  - Firmas digitales opcionales
  - QR codes
  - Watermarks

#### 2. Excel (.xlsx)
- **Librería:** xlsx (SheetJS) o openpyxl (Python)
- **Características:**
  - Múltiples hojas
  - Formato de celdas (colores, bordes)
  - Fórmulas
  - Gráficos embebidos

#### 3. CSV
- **Uso:** Exportación simple de datos tabulares
- **Características:**
  - UTF-8 encoding
  - Delimiter configurable (coma, punto y coma)
  - Header row

### Destinos de Exportación

1. **Download directo:** Usuario descarga desde navegador
2. **Email:** Envío automático a lista de distribución
3. **FTP/SFTP:** Upload a servidor externo
4. **Local storage:** Guardado en servidor ThingsBoard
5. **S3/Cloud:** Upload a AWS S3, Azure Blob, etc.

---

## Configurador de Reportes Automáticos

### Página: Configuración de Exportaciones

**Ubicación:** `gdt/reportes/export-configurator`

### Funcionalidades

#### 1. Crear Scheduled Report

**Parámetros:**
- **Report Type:** Dropdown con todos los tipos de reportes
- **Name:** Nombre descriptivo
- **Enabled:** Toggle on/off
- **Schedule:**
  - Frequency: Daily, Weekly, Monthly, Custom (cron expression)
  - Time: HH:MM
  - Timezone
  - Days of week (si weekly)
  - Day of month (si monthly)
- **Parameters:**
  - Tank ID(s): Multi-select
  - Date range type: Last 24h, Last 7 days, Last month, Custom
  - Filters específicos del reporte
- **Format:** PDF, Excel, CSV (multi-select)
- **Destination:**
  - Type: Email, FTP, S3, Local
  - Configuration:
    - Email: Lista de destinatarios, subject template
    - FTP: Host, port, username, password, path
    - S3: Bucket, region, access key, secret key, path
    - Local: Path en servidor

**Ejemplo de Configuración:**
```json
{
  "id": "scheduled-report-001",
  "name": "Daily Inventory Report - Crude Tanks",
  "enabled": true,
  "reportType": "daily_inventory",
  "schedule": {
    "frequency": "daily",
    "time": "23:59",
    "timezone": "UTC"
  },
  "parameters": {
    "tankIds": ["tank-101", "tank-102", "tank-103"],
    "productFilter": "Crude Oil"
  },
  "format": ["pdf", "excel"],
  "destinations": [
    {
      "type": "email",
      "config": {
        "recipients": ["manager@company.com", "operator@company.com"],
        "subject": "Daily Inventory Report - {{date}}"
      }
    },
    {
      "type": "s3",
      "config": {
        "bucket": "gdt-reports",
        "region": "us-east-1",
        "path": "daily-inventory/{{year}}/{{month}}/"
      }
    }
  ]
}
```

#### 2. Lista de Scheduled Reports

**Funcionalidades:**
- Tabla con todos los reportes programados
- Columnas:
  - Name
  - Report Type
  - Schedule (human-readable)
  - Last Run
  - Next Run
  - Status (enabled/disabled)
  - Actions (Edit, Delete, Run Now, View History)
- Filtros: Report type, Enabled status
- Búsqueda por nombre

#### 3. Execution History

**Funcionalidades:**
- Historial de ejecuciones de reportes
- Columnas:
  - Execution Time
  - Report Name
  - Status (Success, Failed)
  - Duration
  - Output files (links para descargar)
  - Error message (si failed)

#### 4. Notificaciones

**Configuración:**
- Notificar en success
- Notificar solo en failure
- Slack webhook (opcional)

---

## Especificaciones Técnicas

### Arquitectura

```
┌─────────────────┐
│  Frontend       │
│  (Angular)      │
│  - UI de reportes│
│  - Configurador │
└────────┬────────┘
         │ HTTP
         ↓
┌─────────────────┐
│  ThingsBoard    │
│  REST API       │
│  - Telemetry    │
│  - Attributes   │
│  - Assets       │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  Report Service │
│  (Backend)      │
│  - Generator    │
│  - Scheduler    │
│  - Exporter     │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  Storage        │
│  - S3/Local     │
│  - File Server  │
└─────────────────┘
```

### Backend Report Service

**Tecnología:** Python (Flask/FastAPI) o Node.js (Express)

**Endpoints:**

```
POST /api/reports/generate
Body: {
  "reportType": "daily_inventory",
  "parameters": { ... },
  "format": "pdf"
}
Response: {
  "reportId": "...",
  "downloadUrl": "...",
  "status": "completed"
}

GET /api/reports/{reportId}
Response: Binary (PDF/Excel/CSV)

POST /api/reports/schedule
Body: { ... (scheduled report config) }
Response: { "scheduleId": "..." }

GET /api/reports/scheduled
Response: [ ... lista de scheduled reports ... ]

DELETE /api/reports/scheduled/{scheduleId}

POST /api/reports/scheduled/{scheduleId}/run
Response: { "executionId": "..." }

GET /api/reports/executions
Response: [ ... historial de ejecuciones ... ]
```

### Scheduler

**Tecnología:** Cron jobs, APScheduler (Python), node-cron (Node.js), o Quartz (Java)

**Funcionalidades:**
- Ejecutar reportes según schedule configurado
- Retry logic en caso de fallo
- Logging de ejecuciones
- Notificaciones de success/failure

### PDF Generation

**Librería:** jsPDF (JavaScript) o reportlab (Python)

**Templates:**
- HTML templates con placeholders
- Conversión HTML → PDF con CSS
- Embebimiento de gráficos como imágenes

**Ejemplo (Python reportlab):**
```python
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.lib.units import inch

def generate_daily_inventory_pdf(data):
    filename = f"daily_inventory_{date}.pdf"
    c = canvas.Canvas(filename, pagesize=letter)
    width, height = letter

    # Header
    c.drawString(1*inch, height - 1*inch, "DAILY INVENTORY REPORT")
    c.drawString(1*inch, height - 1.3*inch, f"Date: {data['date']}")

    # Table
    y = height - 2*inch
    for tank in data['tanks']:
        c.drawString(1*inch, y, f"{tank['tag']} - {tank['product']}")
        c.drawString(3*inch, y, f"{tank['level']}")
        c.drawString(4*inch, y, f"{tank['nsv']}")
        y -= 0.3*inch

    c.save()
    return filename
```

### Excel Generation

**Librería:** xlsx (SheetJS)

**Ejemplo:**
```typescript
import * as XLSX from 'xlsx';

generateExcelReport(data: any) {
  const ws = XLSX.utils.json_to_sheet(data.tanks);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Inventory");

  // Add summary sheet
  const summaryData = [
    { Product: 'Crude Oil', Total: 125340 },
    { Product: 'Diesel', Total: 85200 }
  ];
  const ws2 = XLSX.utils.json_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws2, "Summary");

  XLSX.writeFile(wb, `inventory_${date}.xlsx`);
}
```

---

## Conclusión

El sistema de reportes e informes proporciona **25 tipos de reportes** que cubren todas las necesidades operacionales, de análisis, custody transfer y cumplimiento regulatorio. La implementación del configurador de exportaciones automáticas permite a los operadores programar reportes sin intervención manual.

### Resumen de Implementación

**FASE 3 del Roadmap:**
- **Duración:** 2.5 meses
- **Reportes a implementar:** 25 tipos
- **Formatos:** PDF, Excel, CSV
- **Destinos:** Download, Email, FTP, S3
- **Scheduler:** Reportes automáticos configurables

**Priorización:**
1. **Alta Prioridad:** Reportes 1-11 (Inventario y Custody Transfer)
2. **Media Prioridad:** Reportes 12-19 (Análisis e Históricos)
3. **Baja Prioridad:** Reportes 20-25 (Cumplimiento - para FASE 5)

---

## Referencias

**Basado en funcionalidades de:**
- Rosemount TankMaster WinOPI
- Rosemount TankMaster Inventory Management Software
- OIML R85:2008 requirements
- API MPMS Chapter 12 standards

**Sources:**
- [Rosemount TankMaster Inventory Management Software | Emerson US](https://www.emerson.com/en-us/automation/measurement-instrumentation/tank-gauging-system/about-tankmaster-inventory-management-software)
- [Rosemount TankMaster WinOPI Manual](https://www.emerson.com/documents/automation/manual-rosemount-tankmaster-winopi-inventory-management-software-en-4886228.pdf)
