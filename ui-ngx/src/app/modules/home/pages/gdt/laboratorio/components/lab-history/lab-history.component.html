<div class="tb-form-panel stroked">
  <div class="tb-form-panel-title">
    Historial de Análisis de Laboratorio
    <span fxFlex></span>
    <button mat-icon-button
            matTooltip="Exportar a CSV"
            (click)="exportToCSV()"
            [disabled]="!dataSource.data || dataSource.data.length === 0">
      <mat-icon>download</mat-icon>
    </button>
  </div>

  <div class="table-container">
    <div *ngIf="loading" class="loading-overlay">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div *ngIf="!selectedTank" class="no-data-message">
      <mat-icon>info</mat-icon>
      <p>Seleccione un tanque para ver el historial</p>
    </div>

    <div *ngIf="selectedTank && !loading && (!dataSource.data || dataSource.data.length === 0)" class="no-data-message">
      <mat-icon>inbox</mat-icon>
      <p>No hay análisis de laboratorio para este tanque</p>
    </div>

    <table mat-table
           [dataSource]="dataSource"
           matSort
           *ngIf="selectedTank && dataSource.data && dataSource.data.length > 0"
           class="mat-elevation-z0">

      <!-- Timestamp Column -->
      <ng-container matColumnDef="timestamp">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha/Hora</th>
        <td mat-cell *matCellDef="let entry">{{ formatDate(entry.timestamp) }}</td>
      </ng-container>

      <!-- API Gravity Column -->
      <ng-container matColumnDef="apiGravity">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>API Gravity</th>
        <td mat-cell *matCellDef="let entry">
          {{ entry.apiGravity ? (entry.apiGravity | number:'1.2-2') + ' °API' : 'N/A' }}
        </td>
      </ng-container>

      <!-- BS&W Column -->
      <ng-container matColumnDef="bsw">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>BS&W</th>
        <td mat-cell *matCellDef="let entry" [class.bsw-warning]="entry.bsw && entry.bsw > 1">
          {{ entry.bsw ? (entry.bsw | number:'1.2-2') + ' %' : 'N/A' }}
        </td>
      </ng-container>

      <!-- Temperature Column -->
      <ng-container matColumnDef="temperature">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Temperatura</th>
        <td mat-cell *matCellDef="let entry">
          {{ entry.manualTemperature ? (entry.manualTemperature | number:'1.2-2') + ' °C' : 'N/A' }}
        </td>
      </ng-container>

      <!-- Analyst Column -->
      <ng-container matColumnDef="operatorName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Analista</th>
        <td mat-cell *matCellDef="let entry">{{ entry.operatorName }}</td>
      </ng-container>

      <!-- Notes Column -->
      <ng-container matColumnDef="notes">
        <th mat-header-cell *matHeaderCellDef>Observaciones</th>
        <td mat-cell *matCellDef="let entry" class="notes-cell">
          <span [matTooltip]="entry.notes || ''" matTooltipPosition="above">
            {{ entry.notes || '-' }}
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]"
                   showFirstLastButtons
                   *ngIf="selectedTank && dataSource.data && dataSource.data.length > 0">
    </mat-paginator>
  </div>
</div>
