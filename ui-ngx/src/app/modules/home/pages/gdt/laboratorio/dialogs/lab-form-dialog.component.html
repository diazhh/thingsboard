<!--

    Copyright © 2016-2025 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<h2 mat-dialog-title>
  <mat-icon class="tb-mat-20">science</mat-icon>
  <span>Registrar Análisis de Laboratorio</span>
</h2>

<mat-dialog-content>
  <form [formGroup]="labForm" fxLayout="column" fxLayoutGap="16px">
    
    <!-- Tank Selector -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Tanque</mat-label>
      <mat-select [(value)]="selectedTank" [compareWith]="compareTanks">
        <mat-option *ngFor="let tank of data.tanks" [value]="tank">
          {{ tank.attributes.tankTag || tank.asset.name }} - {{ tank.attributes.productName || 'Sin producto' }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>storage</mat-icon>
      <mat-error *ngIf="!selectedTank">
        Debe seleccionar un tanque
      </mat-error>
    </mat-form-field>

    <!-- Timestamp -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Fecha y Hora</mat-label>
      <input matInput
             [matDatepicker]="picker"
             formControlName="timestamp"
             required>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="labForm.get('timestamp').hasError('required')">
        La fecha y hora son requeridas
      </mat-error>
    </mat-form-field>

    <!-- API Gravity -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Gravedad API (°API)</mat-label>
      <input matInput
             type="number"
             formControlName="apiGravity"
             placeholder="Ej: 35.5"
             required>
      <mat-icon matSuffix>opacity</mat-icon>
      <mat-hint>Gravedad API del producto</mat-hint>
      <mat-error *ngIf="labForm.get('apiGravity').hasError('required')">
        La gravedad API es requerida
      </mat-error>
      <mat-error *ngIf="labForm.get('apiGravity').hasError('min')">
        La gravedad API debe ser mayor o igual a 0
      </mat-error>
      <mat-error *ngIf="labForm.get('apiGravity').hasError('max')">
        La gravedad API debe ser menor o igual a 100
      </mat-error>
    </mat-form-field>

    <!-- BS&W -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>BS&W (%)</mat-label>
      <input matInput
             type="number"
             formControlName="bsw"
             placeholder="Ej: 0.5"
             required>
      <mat-icon matSuffix>water_drop</mat-icon>
      <mat-hint>Sedimento básico y agua</mat-hint>
      <mat-error *ngIf="labForm.get('bsw').hasError('required')">
        BS&W es requerido
      </mat-error>
      <mat-error *ngIf="labForm.get('bsw').hasError('min')">
        BS&W debe ser mayor o igual a 0
      </mat-error>
      <mat-error *ngIf="labForm.get('bsw').hasError('max')">
        BS&W debe ser menor o igual a 100
      </mat-error>
    </mat-form-field>

    <!-- Temperature -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Temperatura (°C)</mat-label>
      <input matInput
             type="number"
             formControlName="temperature"
             placeholder="Ej: 25.5">
      <mat-icon matSuffix>thermostat</mat-icon>
      <mat-hint>Temperatura del producto (opcional)</mat-hint>
      <mat-error *ngIf="labForm.get('temperature').hasError('min')">
        La temperatura debe ser mayor a -50°C
      </mat-error>
      <mat-error *ngIf="labForm.get('temperature').hasError('max')">
        La temperatura debe ser menor a 150°C
      </mat-error>
    </mat-form-field>

    <!-- Analyst -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Analista</mat-label>
      <input matInput
             formControlName="analyst"
             placeholder="Nombre del analista"
             required>
      <mat-icon matSuffix>person</mat-icon>
      <mat-error *ngIf="labForm.get('analyst').hasError('required')">
        El nombre del analista es requerido
      </mat-error>
    </mat-form-field>

    <!-- Observations -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Observaciones</mat-label>
      <textarea matInput
                formControlName="observations"
                rows="3"
                placeholder="Notas adicionales..."></textarea>
      <mat-icon matSuffix>note</mat-icon>
    </mat-form-field>

    <!-- Tank Info (Read-only) -->
    <div *ngIf="selectedTank" class="tank-info">
      <mat-card>
        <mat-card-content>
          <div fxLayout="row" fxLayoutAlign="space-between center">
            <div>
              <strong>Tanque:</strong> {{ selectedTank.attributes.tankTag || selectedTank.asset.name }}
            </div>
            <div>
              <strong>Producto:</strong> {{ selectedTank.attributes.productName || 'N/A' }}
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button
          (click)="onCancel()"
          [disabled]="saving">
    Cancelar
  </button>
  <button mat-raised-button
          color="primary"
          (click)="onSubmit()"
          [disabled]="labForm.invalid || !selectedTank || saving">
    <mat-icon *ngIf="!saving">save</mat-icon>
    <mat-spinner *ngIf="saving" diameter="20" style="display: inline-block;"></mat-spinner>
    {{ saving ? 'Guardando...' : 'Guardar Análisis' }}
  </button>
</mat-dialog-actions>
