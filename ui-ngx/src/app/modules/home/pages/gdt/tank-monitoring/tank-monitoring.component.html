<!--

    Copyright Â© 2016-2025 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="tank-fleet-container" *ngIf="!selectedTank">
  <!-- Header con controles -->
  <div class="fleet-header">
    <div class="fleet-title">
      <h3>Monitoreo de Flota de Tanques</h3>
      <span class="tank-count">{{ filteredTanks.length }} tanque(s)</span>
    </div>

    <div class="fleet-controls">
      <!-- Toggle de Modo de Vista -->
      <div class="view-mode-toggle">
        <button
          class="btn-view-mode"
          [class.active]="viewMode === 'grid'"
          (click)="changeViewMode('grid')"
          title="Vista de CuadrÃ­cula">
          âŠž CuadrÃ­cula
        </button>
        <button
          class="btn-view-mode"
          [class.active]="viewMode === 'list'"
          (click)="changeViewMode('list')"
          title="Vista de Lista">
          â˜° Lista
        </button>
      </div>

      <!-- Controles de Ordenamiento -->
      <div class="sort-controls">
        <label>Ordenar por:</label>
        <select [(ngModel)]="sortBy" (change)="applyFiltersAndSort(); ctx.detectChanges()">
          <option value="name">Nombre</option>
          <option value="level">Nivel</option>
          <option value="alarm">Alarma</option>
          <option value="volume">Volumen</option>
        </select>
        <button
          class="btn-sort-order"
          (click)="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'; applyFiltersAndSort(); ctx.detectChanges()"
          [title]="sortOrder === 'asc' ? 'Ascendente' : 'Descendente'">
          {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Estado de Carga -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner">âŸ³</div>
    <p>Cargando tanques...</p>
  </div>

  <!-- Estado de Error -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">âš </div>
    <p>{{ error }}</p>
  </div>

  <!-- Vista de CuadrÃ­cula -->
  <div *ngIf="!loading && !error && viewMode === 'grid'" class="tank-grid">
    <div *ngFor="let tank of filteredTanks"
         class="tank-card"
         [class.alarm-critical]="tank.currentAlarmLevel === 'critical'"
         [class.alarm-high]="tank.currentAlarmLevel === 'high'"
         [class.alarm-low]="tank.currentAlarmLevel === 'low'"
         (click)="onTankClick(tank)">

      <!-- Encabezado del Tanque -->
      <div class="tank-card-header">
        <div class="tank-info">
          <h4 class="tank-name">{{ tank.tankName }}</h4>
          <span class="tank-tag">{{ tank.tankTag }}</span>
        </div>
        <div class="tank-status">
          <span class="radar-status" [class]="'status-' + tank.radarStatus">
            {{ tank.radarStatus === 'online' ? 'ðŸ“¡' : 'ðŸ“´' }}
          </span>
        </div>
      </div>

      <!-- Visual del Tanque segÃºn su forma configurada -->
      <div class="tank-visual-compact">
        <svg viewBox="0 0 100 140" class="tank-grid-svg">
          <!-- Tank Shell -->
          <path [attr.d]="getTankSvgPathCompact(tank)" class="tank-shell-compact" />
          
          <!-- Roof -->
          <path [attr.d]="getRoofSvgPathCompact(tank)" class="tank-roof-compact" />
          
          <!-- Liquid Level -->
          <path *ngIf="tank.levelPercent > 0" 
                [attr.d]="getLiquidPathCompact(tank)" 
                [class]="'tank-liquid-compact ' + (tank.currentAlarmLevel || 'none')" />
          
          <!-- Level percentage -->
          <text x="50" y="75" text-anchor="middle" class="level-percent-compact">
            {{ tank.levelPercent | number:'1.0-0' }}%
          </text>
        </svg>
      </div>

      <!-- Indicadores del Tanque -->
      <div class="tank-indicators-compact">
        <div class="indicator">
          <span class="label">Nivel:</span>
          <span class="value">{{ tank.levelPercent | number:'1.1-1' }}% ({{ tank.level | levelFormat }})</span>
        </div>
        <div class="indicator">
          <span class="label">Volumen:</span>
          <span class="value">{{ tank.volumeCurrent | number:'1.0-0' }} {{ tank.volumeGSV ? 'bbl' : 'mÂ³' }}</span>
        </div>
        <div class="indicator">
          <span class="label">Producto:</span>
          <span class="value">{{ tank.productName }}</span>
        </div>
        <div class="indicator">
          <span class="label">Temp:</span>
          <span class="value">{{ tank.temperatureAvg | number:'1.1-1' }}Â°C</span>
        </div>
        <div class="indicator api-indicator" *ngIf="tank.apiGravity">
          <span class="label">API:</span>
          <span class="value">{{ tank.apiGravity | number:'1.1-1' }}Â°</span>
        </div>
      </div>

      <!-- Badge de Alarma -->
      <div *ngIf="tank.activeAlarms && tank.activeAlarms.length > 0" class="alarm-badge">
        <span>âš  {{ tank.activeAlarms.length }} alarma(s)</span>
      </div>

      <!-- Indicador de Ver Detalle -->
      <div class="view-detail-hint">
        Click para ver detalle â†’
      </div>
    </div>
  </div>

  <!-- Vista de Lista -->
  <div *ngIf="!loading && !error && viewMode === 'list'" class="tank-list">
    <table class="tank-table">
      <thead>
        <tr>
          <th (click)="changeSortBy('name')" class="sortable">
            Tanque
            <span *ngIf="sortBy === 'name'">
              {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
            </span>
          </th>
          <th>Producto</th>
          <th (click)="changeSortBy('level')" class="sortable">
            Nivel
            <span *ngIf="sortBy === 'level'">
              {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
            </span>
          </th>
          <th (click)="changeSortBy('volume')" class="sortable">
            Volumen
            <span *ngIf="sortBy === 'volume'">
              {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
            </span>
          </th>
          <th>Temperatura</th>
          <th>API Gravity</th>
          <th>Estado</th>
          <th (click)="changeSortBy('alarm')" class="sortable">
            Alarmas
            <span *ngIf="sortBy === 'alarm'">
              {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tank of filteredTanks"
            class="tank-row"
            [class.alarm-critical]="tank.currentAlarmLevel === 'critical'"
            [class.alarm-high]="tank.currentAlarmLevel === 'high'"
            [class.alarm-low]="tank.currentAlarmLevel === 'low'"
            (click)="onTankClick(tank)">
          <td class="tank-name-cell">
            <div class="tank-name">{{ tank.tankName }}</div>
            <div class="tank-tag">{{ tank.tankTag }}</div>
          </td>
          <td>{{ tank.productName }}</td>
          <td>
            <div class="level-cell">
              <div class="level-bar">
                <div class="level-fill"
                     [style.width.%]="tank.levelPercent"
                     [class.level-critical]="tank.currentAlarmLevel === 'critical'"
                     [class.level-high]="tank.currentAlarmLevel === 'high'"
                     [class.level-low]="tank.currentAlarmLevel === 'low'">
                </div>
              </div>
              <span class="level-text">{{ tank.levelPercent | number:'1.1-1' }}%</span>
            </div>
          </td>
          <td>
            {{ tank.volumeCurrent | number:'1.0-0' }} {{ tank.volumeGSV ? 'bbl' : 'mÂ³' }}
          </td>
          <td>
            {{ tank.temperatureAvg | number:'1.1-1' }}Â°C
          </td>
          <td>
            {{ tank.apiGravity ? (tank.apiGravity | number:'1.1-1') + 'Â°' : '-' }}
          </td>
          <td>
            <span class="status-badge" [class]="'status-' + tank.radarStatus">
              {{ getRadarStatusText(tank.radarStatus) }}
            </span>
          </td>
          <td>
            <span *ngIf="tank.activeAlarms && tank.activeAlarms.length > 0"
                  class="alarm-count"
                  [class]="'alarm-' + tank.currentAlarmLevel">
              âš  {{ tank.activeAlarms.length }}
            </span>
            <span *ngIf="!tank.activeAlarms || tank.activeAlarms.length === 0" class="no-alarm">
              âœ“
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Estado VacÃ­o -->
  <div *ngIf="!loading && !error && filteredTanks.length === 0" class="empty-state">
    <div class="empty-icon">ðŸ“¦</div>
    <p>No se encontraron tanques</p>
    <small>Configure los datasources o verifique el filtro de perfil de activos</small>
  </div>
</div>

<!-- Vista de Detalle del Tanque -->
<tb-tank-detail
  *ngIf="selectedTank"
  [ctx]="ctx"
  [tank]="selectedTank"
  (back)="closeTankDetail()">
</tb-tank-detail>
