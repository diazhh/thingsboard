<!--

    Copyright © 2016-2025 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<h2 mat-dialog-title>Cerrar Lote {{ batch.batchNumber }}</h2>

<div mat-dialog-content>
  <form [formGroup]="closeBatchForm" fxLayout="column" fxLayoutGap="16px">
    
    <!-- Capture Mode Toggle -->
    <div fxLayout="row" fxLayoutAlign="space-between center">
      <h3>Medición de Cierre</h3>
      <mat-slide-toggle 
        [(ngModel)]="useAutomaticCapture" 
        (change)="toggleCaptureMode()"
        [ngModelOptions]="{standalone: true}">
        <mat-icon matTooltip="Captura automática desde telemetría">
          {{ useAutomaticCapture ? 'bolt' : 'edit' }}
        </mat-icon>
        {{ useAutomaticCapture ? 'Automático' : 'Manual' }}
      </mat-slide-toggle>
    </div>

    <!-- Automatic Gauge Display -->
    <mat-card *ngIf="useAutomaticCapture && (capturingGauge || gaugeSnapshot)" class="gauge-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon *ngIf="capturingGauge" class="spinner">hourglass_empty</mat-icon>
          <mat-icon *ngIf="!capturingGauge && gaugeSnapshot" color="primary">verified</mat-icon>
          {{ capturingGauge ? 'Capturando datos...' : 'Datos de Cierre Capturados' }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content *ngIf="gaugeSnapshot && !capturingGauge" fxLayout="column" fxLayoutGap="12px">
        <div fxLayout="row wrap" fxLayoutGap="16px">
          <div fxFlex="45" class="gauge-value">
            <div class="gauge-label">Nivel</div>
            <div class="gauge-number">{{ gaugeSnapshot.level | number:'1.0-0' }} mm</div>
          </div>
          <div fxFlex="45" class="gauge-value">
            <div class="gauge-label">Temperatura</div>
            <div class="gauge-number">{{ gaugeSnapshot.temperature | number:'1.1-1' }} °C</div>
          </div>
          <div fxFlex="45" class="gauge-value">
            <div class="gauge-label">API Gravity</div>
            <div class="gauge-number">{{ gaugeSnapshot.apiGravity | number:'1.1-1' }} °API</div>
          </div>
          <div fxFlex="45" class="gauge-value">
            <div class="gauge-label">BS&W</div>
            <div class="gauge-number">{{ gaugeSnapshot.bsw | number:'1.2-2' }} %</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Capture Error Message -->
    <div *ngIf="captureError && !capturingGauge" class="capture-error-message">
      <mat-icon>error</mat-icon>
      <div fxLayout="column" fxFlex>
        <span>{{ captureError }}</span>
        <button mat-button (click)="captureClosingGauge(batch.tankId)" *ngIf="batch?.tankId">
          <mat-icon>refresh</mat-icon>
          Reintentar
        </button>
      </div>
    </div>

    <!-- Manual Gauge Input -->
    <div *ngIf="!useAutomaticCapture">
      <div fxLayout="row" fxLayoutGap="16px">
        <!-- Closing Level -->
        <mat-form-field appearance="outline" fxFlex>
          <mat-label>Nivel de Cierre (mm)</mat-label>
          <input matInput type="number" formControlName="closingLevel" required>
          <mat-error *ngIf="closeBatchForm.get('closingLevel').hasError('required')">
            El nivel es requerido
          </mat-error>
        </mat-form-field>

        <!-- Closing Temperature -->
        <mat-form-field appearance="outline" fxFlex>
          <mat-label>Temperatura (°C)</mat-label>
          <input matInput type="number" step="0.1" formControlName="closingTemperature" required>
          <mat-error *ngIf="closeBatchForm.get('closingTemperature').hasError('required')">
            La temperatura es requerida
          </mat-error>
        </mat-form-field>
      </div>

      <div fxLayout="row" fxLayoutGap="16px">
        <!-- Closing API Gravity -->
        <mat-form-field appearance="outline" fxFlex>
          <mat-label>API Gravity (°API)</mat-label>
          <input matInput type="number" step="0.01" formControlName="closingApiGravity" required>
          <mat-error *ngIf="closeBatchForm.get('closingApiGravity').hasError('required')">
            El API Gravity es requerido
          </mat-error>
        </mat-form-field>

        <!-- Closing BS&W -->
        <mat-form-field appearance="outline" fxFlex>
          <mat-label>BS&W (%)</mat-label>
          <input matInput type="number" step="0.01" formControlName="closingBsw">
          <mat-hint>Basic Sediment and Water</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <h3>Información Adicional</h3>

    <!-- Operator -->
    <mat-form-field appearance="outline">
      <mat-label>Operador</mat-label>
      <input matInput formControlName="operator">
    </mat-form-field>

    <!-- Notes -->
    <mat-form-field appearance="outline">
      <mat-label>Notas</mat-label>
      <textarea matInput formControlName="notes" rows="3"></textarea>
    </mat-form-field>

  </form>
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancelar</button>
  <button mat-raised-button 
          color="primary" 
          (click)="onSubmit()"
          [disabled]="!canSubmit() || loading">
    ✓ Cerrar Lote
  </button>
</div>
