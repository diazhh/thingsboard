<!--

    Copyright © 2016-2025 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="gdt-batch-management">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">inventory_2</mat-icon>
        <div>
          <h1>Gestión de Batches</h1>
          <p class="subtitle">Administre batches de recepción y despacho</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="createBatch()">
          <mat-icon>add</mat-icon>
          Crear Batch
        </button>
        <button mat-icon-button
                matTooltip="Exportar a CSV"
                (click)="exportToCsv()"
                [disabled]="filteredBatches.length === 0">
          <mat-icon>download</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="content-container" fxLayout="column">

    <!-- Filters Panel -->
    <div class="filters-panel">
      <div class="filters-header">
        <h3>Filtros</h3>
        <button mat-icon-button
                matTooltip="Limpiar filtros"
                (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
        </button>
      </div>

      <div fxLayout="row wrap" fxLayoutGap="16px" fxLayoutAlign="start center">
        
        <!-- Tank Filter -->
        <mat-form-field appearance="outline" fxFlex="1 1 200px">
          <mat-label>Tanque</mat-label>
          <mat-select [(value)]="selectedTankId" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let tank of tanks" [value]="tank.asset.id.id">
              {{ tank.attributes.tankTag || tank.asset.name }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>storage</mat-icon>
        </mat-form-field>

        <!-- Type Filter -->
        <mat-form-field appearance="outline" fxFlex="1 1 150px">
          <mat-label>Tipo</mat-label>
          <mat-select [(value)]="selectedType" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let opt of typeOptions" [value]="opt.value">
              {{ opt.label }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>category</mat-icon>
        </mat-form-field>

        <!-- Status Filter -->
        <mat-form-field appearance="outline" fxFlex="1 1 150px">
          <mat-label>Estado</mat-label>
          <mat-select [(value)]="selectedStatus" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>info</mat-icon>
        </mat-form-field>

        <!-- Search -->
        <mat-form-field appearance="outline" fxFlex="1 1 200px">
          <mat-label>Buscar</mat-label>
          <input matInput
                 [(ngModel)]="searchText"
                 (input)="onSearchChange()"
                 placeholder="Batch # o Tanque">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <!-- Batches Table -->
    <div class="table-container">
      <mat-progress-bar *ngIf="loading" mode="indeterminate" color="primary"></mat-progress-bar>

      <div *ngIf="!loading && filteredBatches.length === 0" class="no-data-message">
        <mat-icon>inbox</mat-icon>
        <p>No hay batches que coincidan con los filtros</p>
      </div>

      <div class="table-wrapper" *ngIf="!loading && filteredBatches.length > 0">
        <table mat-table
               [dataSource]="filteredBatches"
               class="batches-table">

        <!-- Batch Number Column -->
        <ng-container matColumnDef="batchNumber">
          <th mat-header-cell *matHeaderCellDef>Batch #</th>
          <td mat-cell *matCellDef="let batch">
            <strong>{{ batch.batchNumber }}</strong>
          </td>
        </ng-container>

        <!-- Tank Name Column -->
        <ng-container matColumnDef="tankName">
          <th mat-header-cell *matHeaderCellDef>Tanque</th>
          <td mat-cell *matCellDef="let batch">{{ batch.tankName }}</td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Tipo</th>
          <td mat-cell *matCellDef="let batch">
            <mat-chip-set>
              <mat-chip [color]="batch.batchType === 'receiving' ? 'primary' : 'accent'" selected>
                {{ batch.batchType === 'receiving' ? 'Recepción' : 'Despacho' }}
              </mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let batch">
            <mat-chip-set>
              <mat-chip [color]="getStatusColor(batch.status)" selected>
                <mat-icon>{{ getStatusIcon(batch.status) }}</mat-icon>
                {{ batch.status | uppercase }}
              </mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <!-- Opening Column -->
        <ng-container matColumnDef="opening">
          <th mat-header-cell *matHeaderCellDef>Apertura</th>
          <td mat-cell *matCellDef="let batch">
            {{ formatDate(batch.opening.timestamp) }}
          </td>
        </ng-container>

        <!-- Closing Column -->
        <ng-container matColumnDef="closing">
          <th mat-header-cell *matHeaderCellDef>Cierre</th>
          <td mat-cell *matCellDef="let batch">
            {{ batch.closing ? formatDate(batch.closing.timestamp) : '-' }}
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Creado</th>
          <td mat-cell *matCellDef="let batch">
            {{ formatDate(batch.createdAt) }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let batch">
            <button mat-icon-button
                    matTooltip="Ver detalle"
                    (click)="viewBatchDetail(batch)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button
                    matTooltip="Descargar reporte"
                    (click)="downloadReport(batch)"
                    *ngIf="batch.reportPdfUrl">
              <mat-icon>download</mat-icon>
            </button>
            <button mat-icon-button
                    matTooltip="Cerrar batch"
                    (click)="closeBatch(batch)"
                    *ngIf="batch.status === 'open'">
              <mat-icon>lock</mat-icon>
            </button>
            <button mat-icon-button
                    matTooltip="Recalcular"
                    (click)="recalculateBatch(batch)"
                    *ngIf="batch.status === 'closed'">
              <mat-icon>refresh</mat-icon>
            </button>
          </td>
        </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>

  </div>
</div>
