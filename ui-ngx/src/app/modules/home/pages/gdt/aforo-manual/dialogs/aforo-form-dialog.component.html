<!--

    Copyright © 2016-2025 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<h2 mat-dialog-title>
  <mat-icon class="tb-mat-20">edit</mat-icon>
  <span>Registrar Aforo Manual</span>
</h2>

<mat-dialog-content>
  <form [formGroup]="aforoForm" fxLayout="column" fxLayoutGap="16px">
    
    <!-- Tank Selector -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Tanque</mat-label>
      <mat-select [(value)]="selectedTank" [compareWith]="compareTanks">
        <mat-option *ngFor="let tank of data.tanks" [value]="tank">
          {{ tank.attributes.tankTag || tank.asset.name }} - {{ tank.attributes.productName || 'Sin producto' }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>storage</mat-icon>
      <mat-error *ngIf="!selectedTank">
        Debe seleccionar un tanque
      </mat-error>
    </mat-form-field>

    <!-- Timestamp -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Fecha y Hora</mat-label>
      <input matInput
             [matDatepicker]="picker"
             formControlName="timestamp"
             required>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="aforoForm.get('timestamp').hasError('required')">
        La fecha y hora son requeridas
      </mat-error>
    </mat-form-field>

    <!-- Manual Level -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Nivel Manual (mm)</mat-label>
      <input matInput
             type="number"
             formControlName="manualLevel"
             placeholder="Ej: 5000"
             required>
      <mat-icon matSuffix>straighten</mat-icon>
      <mat-hint>Nivel medido manualmente en milímetros</mat-hint>
      <mat-error *ngIf="aforoForm.get('manualLevel').hasError('required')">
        El nivel manual es requerido
      </mat-error>
      <mat-error *ngIf="aforoForm.get('manualLevel').hasError('min')">
        El nivel debe ser mayor o igual a 0
      </mat-error>
    </mat-form-field>

    <!-- Manual Temperature -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Temperatura (°C)</mat-label>
      <input matInput
             type="number"
             formControlName="manualTemperature"
             placeholder="Ej: 25.5">
      <mat-icon matSuffix>thermostat</mat-icon>
      <mat-hint>Temperatura del producto (opcional)</mat-hint>
      <mat-error *ngIf="aforoForm.get('manualTemperature').hasError('min')">
        La temperatura debe ser mayor a -50°C
      </mat-error>
      <mat-error *ngIf="aforoForm.get('manualTemperature').hasError('max')">
        La temperatura debe ser menor a 150°C
      </mat-error>
    </mat-form-field>

    <!-- Operator Name -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Operador</mat-label>
      <input matInput
             type="text"
             formControlName="operatorName"
             placeholder="Nombre del operador"
             required>
      <mat-icon matSuffix>person</mat-icon>
      <mat-hint>Nombre de la persona que realiza el aforo</mat-hint>
      <mat-error *ngIf="aforoForm.get('operatorName').hasError('required')">
        El nombre del operador es requerido
      </mat-error>
    </mat-form-field>

    <!-- Notes -->
    <mat-form-field appearance="outline" class="mat-block">
      <mat-label>Notas</mat-label>
      <textarea matInput
                formControlName="notes"
                rows="3"
                placeholder="Observaciones adicionales..."></textarea>
      <mat-icon matSuffix>note</mat-icon>
    </mat-form-field>

    <!-- Tank Info (Read-only) -->
    <div *ngIf="selectedTank" class="tank-info">
      <mat-card>
        <mat-card-content>
          <div fxLayout="row" fxLayoutAlign="space-between center">
            <div>
              <strong>Tanque:</strong> {{ selectedTank.attributes.tankTag || selectedTank.asset.name }}
            </div>
            <div>
              <strong>Producto:</strong> {{ selectedTank.attributes.productName || 'N/A' }}
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button
          (click)="onCancel()"
          [disabled]="saving">
    Cancelar
  </button>
  <button mat-raised-button
          color="primary"
          (click)="onSubmit()"
          [disabled]="aforoForm.invalid || !selectedTank || saving">
    <mat-icon *ngIf="!saving">save</mat-icon>
    <mat-spinner *ngIf="saving" diameter="20" style="display: inline-block;"></mat-spinner>
    {{ saving ? 'Guardando...' : 'Guardar Aforo' }}
  </button>
</mat-dialog-actions>
