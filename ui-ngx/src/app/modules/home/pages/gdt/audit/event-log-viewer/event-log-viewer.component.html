<div class="tb-absolute-fill">
  <!-- Toolbar -->
  <mat-toolbar color="primary">
    <h2>
      <mat-icon class="tb-mat-20">history</mat-icon>
      <span>Visor de Eventos</span>
    </h2>
    <span fxFlex></span>
    <button mat-icon-button
            matTooltip="Ayuda"
            matTooltipPosition="below">
      <mat-icon>help_outline</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Content -->
  <div class="mat-content tb-form-panel no-border no-padding" fxLayout="column" style="overflow: auto;">
    
    <!-- Filters Panel -->
    <div class="filters-panel">
      <div class="filters-header">
        <h3>Filtros</h3>
        <button mat-icon-button
                matTooltip="Limpiar filtros"
                (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
        </button>
      </div>

      <form [formGroup]="filterForm">
        <div class="filters-grid">
          <!-- Search -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Buscar</mat-label>
            <input matInput formControlName="searchQuery" placeholder="Descripción, usuario, entidad...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Category -->
          <mat-form-field appearance="outline">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="category">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let cat of categories" [value]="cat">
                {{ cat | titlecase }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
          </mat-form-field>

          <!-- Severity -->
          <mat-form-field appearance="outline">
            <mat-label>Severidad</mat-label>
            <mat-select formControlName="severity">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let sev of severities" [value]="sev">
                {{ sev }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>warning</mat-icon>
          </mat-form-field>

          <!-- Status -->
          <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="status">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let stat of statuses" [value]="stat">
                {{ stat }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>info</mat-icon>
          </mat-form-field>

          <!-- User Name -->
          <mat-form-field appearance="outline">
            <mat-label>Usuario</mat-label>
            <input matInput formControlName="userName" placeholder="Nombre de usuario">
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <!-- Entity Type -->
          <mat-form-field appearance="outline">
            <mat-label>Tipo de Entidad</mat-label>
            <mat-select formControlName="entityType">
              <mat-option value="">Todas</mat-option>
              <mat-option value="TANK">Tanque</mat-option>
              <mat-option value="BATCH">Batch</mat-option>
              <mat-option value="USER">Usuario</mat-option>
              <mat-option value="SYSTEM">Sistema</mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
          </mat-form-field>

          <!-- Time Range -->
          <mat-form-field appearance="outline">
            <mat-label>Rango de Tiempo</mat-label>
            <mat-select [(ngModel)]="selectedTimeRange" [ngModelOptions]="{updateOn: 'change'}">
              <mat-option *ngFor="let range of timeRanges" [value]="range.value">
                {{ range.label }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>schedule</mat-icon>
          </mat-form-field>

          <!-- Custom Date Range (if selected) -->
          <mat-form-field appearance="outline" *ngIf="showCustomDateRange">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="startPicker" [(ngModel)]="customStartDate" [ngModelOptions]="{updateOn: 'change'}">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="showCustomDateRange">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="endPicker" [(ngModel)]="customEndDate" [ngModelOptions]="{updateOn: 'change'}">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Action Buttons -->
        <div class="actions-row">
          <button mat-raised-button color="primary" (click)="loadAuditEvents()" [disabled]="loading">
            <mat-icon>refresh</mat-icon>
            Actualizar
          </button>
          <button mat-raised-button (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Limpiar Filtros
          </button>
          <button mat-raised-button (click)="exportToCSV()">
            <mat-icon>download</mat-icon>
            Exportar CSV
          </button>
          <button mat-raised-button (click)="exportToJSON()">
            <mat-icon>download</mat-icon>
            Exportar JSON
          </button>
        </div>
      </form>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando eventos de auditoría...</p>
    </div>

    <!-- Events Table -->
    <div *ngIf="!loading && dataSource.data.length > 0" class="events-section">
      <h3>Eventos de Auditoría ({{ dataSource.filteredData.length }})</h3>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="events-table">
          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha/Hora</th>
            <td mat-cell *matCellDef="let element">
              {{ element.timestamp | date:'short' }}
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip-list>
                <mat-chip [color]="'primary'" selected>
                  {{ element.category | titlecase }}
                </mat-chip>
              </mat-chip-list>
            </td>
          </ng-container>

          <!-- Severity Column -->
          <ng-container matColumnDef="severity">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Severidad</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip-list>
                <mat-chip [color]="getSeverityColor(element.severity)" selected>
                  {{ element.severity }}
                </mat-chip>
              </mat-chip-list>
            </td>
          </ng-container>

          <!-- User Name Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
            <td mat-cell *matCellDef="let element">
              {{ element.userName }}
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Descripción</th>
            <td mat-cell *matCellDef="let element">
              {{ element.description }}
            </td>
          </ng-container>

          <!-- Entity Name Column -->
          <ng-container matColumnDef="entityName">
            <th mat-header-cell *matHeaderCellDef>Entidad</th>
            <td mat-cell *matCellDef="let element">
              <small>{{ element.entityType }}: {{ element.entityName }}</small>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let element">
              <mat-icon [matTooltip]="element.status">{{ getStatusIcon(element.status) }}</mat-icon>
              {{ element.status }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element">
              <button mat-icon-button (click)="showDetails(element)" matTooltip="Ver detalles">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons>
      </mat-paginator>
    </div>

    <!-- No Data Message -->
    <div *ngIf="!loading && dataSource.data.length === 0" class="no-data-section">
      <mat-icon>inbox</mat-icon>
      <p>No hay eventos de auditoría disponibles</p>
    </div>

    <!-- Event Details Dialog -->
    <div *ngIf="showEventDetails && selectedEvent" class="event-details-overlay">
      <div class="event-details-card">
        <div class="event-details-header">
          <h3>Detalles del Evento</h3>
          <button mat-icon-button (click)="closeDetails()" class="close-button">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="details-grid">
          <div class="detail-item">
            <label>ID del Evento:</label>
            <span>{{ selectedEvent.eventId }}</span>
          </div>
          <div class="detail-item">
            <label>Fecha/Hora:</label>
            <span>{{ selectedEvent.timestamp | date:'medium' }}</span>
          </div>
          <div class="detail-item">
            <label>Categoría:</label>
            <span>{{ selectedEvent.category | titlecase }}</span>
          </div>
          <div class="detail-item">
            <label>Severidad:</label>
            <span>{{ selectedEvent.severity }}</span>
          </div>
          <div class="detail-item">
            <label>Usuario:</label>
            <span>{{ selectedEvent.userName }}</span>
          </div>
          <div class="detail-item">
            <label>Descripción:</label>
            <span>{{ selectedEvent.description }}</span>
          </div>
          <div class="detail-item">
            <label>Tipo de Entidad:</label>
            <span>{{ selectedEvent.entityType }}</span>
          </div>
          <div class="detail-item">
            <label>Nombre de Entidad:</label>
            <span>{{ selectedEvent.entityName }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEvent.oldValue">
            <label>Valor Anterior:</label>
            <span>{{ selectedEvent.oldValue }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEvent.newValue">
            <label>Valor Nuevo:</label>
            <span>{{ selectedEvent.newValue }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEvent.ipAddress">
            <label>Dirección IP:</label>
            <span>{{ selectedEvent.ipAddress }}</span>
          </div>
          <div class="detail-item">
            <label>Estado:</label>
            <span>{{ selectedEvent.status }}</span>
          </div>
          <div class="detail-item full-width">
            <label>Firma Digital (SHA-256):</label>
            <code class="signature">{{ selectedEvent.digitalSignature }}</code>
          </div>
        </div>
        <div class="event-details-actions">
          <button mat-raised-button color="primary" (click)="closeDetails()">
            Cerrar
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
